---
title: "Latent Growth Models Extensions"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

In this tutorial, we are going to use the R package `lavaan` for advanced latent growth models and package `OpenMx` for mixture growth models. 

## Load the pacakges

```{r, message=FALSE, warning=FALSE}
library(lavaan)
library(semPlot)
library(OpenMx)
library(readr)
```

<br>

## Example 1: LGM with time dependent covariates

The data for this example are from 324 non-native English speakers, whose reading ability and writing ability have been measured at three equally spaced time points (1 month apart).

### Read the data

```{r}
lower <- '
42.916
32.060  39.350
29.666  28.796  37.428
18.070  17.553  16.614  20.924
17.863  17.192  16.142  14.665  17.987
17.294  17.261  17.032  14.893  13.786  18.103
'

covmat <- getCov(lower)
smeans <- c(17.080, 18.404, 19.228, 18.590, 19.352, 20.265)

rownames(covmat) <- colnames(covmat) <- c(paste0("read", 1:3), paste0("write", 1:3))

```

<br>


### Fit the model

```{r, echo = F, warning = F, message = F, out.width='80%'}

tdc.model='

interc=~1*write1+1*write2+1*write3
slope=~0*write1+1*write2+2*write3

write1~read1
write2~read2
write3~read3

read1~~interc+slope+read2+read3
read2~~interc+slope+read3
read3~~interc+slope

read1~1
read2~1
read3~1

'

tdc.fit=growth(tdc.model,sample.cov=covmat,sample.mean=smeans,sample.nobs=324)
#summary(tdc.fit,fit.measures=T,standardized=T)


semPaths(tdc.fit, title = T, curvePivot = TRUE, intercepts = T, ask = FALSE, edge.label.cex = 1, sizeMan = 8, title.cex = 2, sizeLat = 10, sizeInt = 3, sizeInt2 = 3, whatLabels = "omit")

```


No special syntax is required for you to fit a LGM with time dependent covariates. You only need to correctly specify the covariance structure and mean structure for your model using the regular `lavaan` model syntax. This is another example showing you that it is more important to have a good understanding of the models before you translate it into programming language. :)


```{r, warning = F}

tdc.model <- '

# latent intercept and slope

interc =~ 1*write1 + 1*write2 + 1*write3
slope =~ 0*write1 + 1*write2 + 2*write3

# path coefficients

write1 ~ read1
write2 ~ read2
write3 ~ read3

# covariances

read1 ~~ interc + slope + read2 + read3
read2 ~~ interc + slope + read3
read3 ~~ interc + slope

# means

read1 ~ 1
read2 ~ 1
read3 ~ 1
 
'

tdc.fit <- growth(tdc.model, sample.cov = covmat, sample.mean = smeans, sample.nobs = 324)
summary(tdc.fit, fit.measures = T, standardized = T)


```

---

## Example 2: Second-order LGM

The second-order LGM is discussed in detail in [Hancock, Kuo, & Lawrence (2001)](https://www.tandfonline.com/doi/abs/10.1207/S15328007SEM0803_7). In this example, we have data collected from 170 male non-native adult English speakers. Their English language ability has been measured monthly for three months. The data is saved in a txt file named "second_order_data.txt". 


### Read the data

```{r,echo=F}
mypath <- "/Volumes/GoogleDrive/My Drive/Dpr/EDMS workshops/SEM2019/SEM Second Course Mplus 2019/Advanced Examples/5. Growth Examples"
```

```{r}
setwd(mypath)  # set working directory to where the data file is stored

second.data <- read.delim("second_order_data.txt", sep = '\t', header = F)
colnames(second.data) <- c('read1', 'read2', 'read3', 'list1', 'list2', 'list3',
                        'speak1', 'speak2', 'speak3', 'write1', 'write2', 'write3')

str(second.data)
summary(second.data)

```

### Fit the model


```{r, echo = F, warning = F, message = F, out.width='80%'}

second.model <- '

english1=~read1+a*list1+b*speak1+c*write1
english2=~read2+a*list2+b*speak2+c*write2
english3=~read3+a*list3+b*speak3+c*write3

interc=~1*english1+1*english2+1*english3
slope=~0*english1+1*english2+2*english3

interc~~slope
interc~1
slope~1

read1~~read2+read3
read2~~read3
list1~~list2+list3
list2~~list3
speak1~~speak2+speak3
speak2~~speak3
write1~~write2+write3
write2~~write3

read1~0*1
read2~0*1
read3~0*1

list1~d*1
list2~d*1
list3~d*1

speak1~e*1
speak2~e*1
speak3~e*1

write1~f*1
write2~f*1
write3~f*1

'

second.fit <- sem(second.model,second.data)
#summary(second.fit,fit.measures=T)

semPaths(second.fit, title = T, curvePivot = TRUE, intercepts = T, ask = FALSE, edge.label.cex = 1, sizeMan = 4, title.cex = 2, sizeLat = 10, sizeInt = 3, sizeInt2 = 3, whatLabels = "omit")

```


There is still no special syntax required for second-order LGM, although the model syntax looks lengthy. There are a few constraints we need to pay special attention to:

1. The item loadings are constrained to be equal across time points (*measurement invariance*).
1. The item whose loading is fixed to 1 also has its intercept fixed to 0.
1. The item intercepts are constrained to be equal across time points.



```{r, warning = F, message = F}

second.model <- '

# first-order latent factors

english1 =~ read1 + a*list1 + b*speak1 + c*write1
english2 =~ read2 + a*list2 + b*speak2 + c*write2
english3 =~ read3 + a*list3 + b*speak3 + c*write3

# second-order growth factors 

interc =~ 1*english1 + 1*english2 + 1*english3
slope =~ 0*english1 + 1*english2 + 2*english3

# second-order factor covariances and intercept

interc ~~ slope
interc ~ 1
slope ~ 1

# residual covariances

read1 ~~ read2 + read3
read2 ~~ read3
list1 ~~ list2 + list3
list2 ~~ list3
speak1 ~~ speak2 + speak3
speak2 ~~ speak3
write1 ~~ write2 + write3
write2 ~~ write3

# fix zero intercepts

read1 ~ 0*1
read2 ~ 0*1
read3 ~ 0*1
 
# equality constraints on the intercepts

list1 ~ d*1
list2 ~ d*1
list3 ~ d*1

speak1 ~ e*1
speak2 ~ e*1
speak3 ~ e*1
 
write1 ~ f*1
write2 ~ f*1
write3 ~ f*1

'

second.fit <- sem(second.model, second.data)
summary(second.fit, fit.measures = T)

```

---

## Example 3: LGM with ordinal data

Assume we want to fit a linear LGM with ordinal data collected at four equally spaced time points. The data is saved in a txt file named "categorical_data.txt" in your course materials. 

### Read the data

```{r,echo=F}
mypath <- "/Volumes/GoogleDrive/My Drive/Dpr/EDMS workshops/SEM2019/SEM Second Course Mplus 2019/Advanced Examples/5. Growth Examples"
```

```{r}
setwd(mypath)  # set working directory to where the data file is stored

cat.data <- read.table("categorical_data.txt", header = F)
colnames(cat.data) <- c("y1", "y2", "y3", "y4")

cat.data <- apply(cat.data, 2, ordered)

str(cat.data)
summary(cat.data)

```

### Fit the model

```{r, echo = F, warning = F, message = F, out.width='80%'}

cat.lgm <- '
interc=~1*y1+1*y2+1*y3+1*y4
slope=~0*y1+1*y2+2*y3+3*y4

interc~0*1
slope~1

y1|a*t1+b*t2
y2|a*t1+b*t2
y3|a*t1+b*t2
y4|a*t1+b*t2

y1~~1*y1
y2~~y2
y3~~y3
y4~~y4

'

cat.fit=sem(cat.lgm,cat.data,ordered=c("y1","y2","y3","y4"),parameterization="theta")
#summary(cat.fit,fit.measures=T)
semPaths(cat.fit, title = T, curvePivot = TRUE, intercepts = T, ask = FALSE, edge.label.cex = 1, sizeMan = 8, title.cex = 2, sizeLat = 10, sizeInt = 5, sizeInt2 = 5, whatLabels = "omit")


```


We define our model using the following model syntax. Some notes for this model syntax:

1. We fix the latent intercept mean to be zero;
1. We use the "|" operator to define the thresholds of the endogenous categorical
variables: y1-y4. The thresholds are named "t1" and "t2" by convention and they are listed on the right side of the formulas. We give them parameter labels to impose the equality constraints.

When calling up the fitting function, we use the `ordered = ` argument to specify the categorical variables. We can also request theta parameterization using the `parameterization =` argument.  


```{r, warning = F, message = F}

cat.lgm <- '

# growth latent factors

interc =~ 1*y1 + 1*y2 + 1*y3 + 1*y4
slope =~ 0*y1 + 1*y2 + 2*y3 + 3*y4


# means of latent factors

interc ~ 0*1
slope ~ 1


# Equality constraints on the threshold
y1 | a*t1 + b*t2
y2 | a*t1 + b*t2
y3 | a*t1 + b*t2
y4 | a*t1 + b*t2


# variances

y1 ~~ 1*y1
y2 ~~ y2
y3 ~~ y3
y4 ~~ y4

'

cat.fit <- sem(cat.lgm, cat.data, ordered = c("y1","y2","y3","y4"), parameterization = "theta")

summary(cat.fit, fit.measures = T)


```


---

## Example 4: Growth Mixture Models

The current version of `lavaan` (v0.6-8) does not support mixture models yet. To do growth mixture models in R, we could use the `OpenMx` package instead. More information about how to use `OpenMx` can be found [here](https://openmx.ssri.psu.edu/documentation).

### Read the data

```{r,echo=F}
mypath <- "/Volumes/GoogleDrive/My Drive/Dpr/EDMS workshops/SEM2019/SEM Second Course Mplus 2019/Advanced Examples/5. Growth Examples"
```

```{r, message=FALSE}
setwd(mypath)  # set working directory to where the data file is stored

mix.data <- readr::read_fwf("mixture_data.txt", fwf_empty("mixture_data.txt", col_names = c('TALC1YR1', 'TALC1YR2', 'TALC1YR3', 'PROB5', 'TAGE1', 'TGENDER1')), na = "-99.00")

str(mix.data)
summary(mix.data)

```

### Fit the model

To fit a growth mixture model using `OpenMx`, we need to specify class-specific models. Let's start with the model for Class 1. In this example we specify the model using the path method via the `mxPath` function.

```{r}
# residual variances
resVars <- mxPath(from = c('TALC1YR1', 'TALC1YR2', 'TALC1YR3'), arrows = 2,
                        free = TRUE, values = c(1,1,1),
                        labels = c("residual1","residual2","residual3") )

# latent variances and covariance
latVars <- mxPath(from = c("intercept", "slope"), arrows = 2, connect = "unique.pairs",
                        free = TRUE, values=c(1, .4, 1), labels = c("var_int", "cov_is", "var_slp") )

# intercept loadings
intLoads <- mxPath(from = "intercept", to = c('TALC1YR1', 'TALC1YR2', 'TALC1YR3'), 
                   arrows = 1, free = FALSE, values = c(1,1,1) )

# slope loadings
slpLoads <- mxPath(from = "slope", to = c('TALC1YR1', 'TALC1YR2', 'TALC1YR3'), arrows = 1,
                        free = FALSE, values = c(0,1,2))
# manifest means
manMeans <- mxPath(from = "one", to = c('TALC1YR1', 'TALC1YR2', 'TALC1YR3'), arrows = 1,
                        free = FALSE, values = c(0,0,0))

# latent means
latMeans <- mxPath(from="one", to = c("intercept", "slope"), arrows = 1,
                        free = TRUE, values = c(5, 0), labels = c("mean_int1", "mean_slp1"))

# enable the likelihood vector
funML <- mxFitFunctionML(vector=TRUE)
class1 <- mxModel("Class1", type = "RAM",
                        manifestVars = c('TALC1YR1', 'TALC1YR2', 'TALC1YR3'),
                        latentVars = c("intercept", "slope"),
                        resVars, latVars, intLoads, slpLoads, manMeans, latMeans,
                        funML)

```


We can specify the model for Class 2 and Class 3 next. As we only allow the latent means to differ across different classes, we can simplify the code by modifying the class1 object, instead of repeating everything above again. 

```{r}
# latent means differ
latMeans2 <- mxPath(from = "one", to = c("intercept", "slope"), arrows = 1,
                        free = TRUE, values = c(4, 0), labels = c("mean_int2", "mean_slp2"))
class2 <- mxModel(class1, name = "Class2", latMeans2)


latMeans3 <- mxPath(from = "one", to = c("intercept", "slope"), arrows = 1,
                        free = TRUE, values = c(2, 1), labels = c("mean_int3", "mean_slp3"))
class3 <- mxModel(class1, name = "Class3", latMeans3)

```

Next we fit the model to the data. 

```{r}
# specify the class proportions
classP <- mxMatrix(type = "Full", nrow = 3, ncol = 1,
                        free = c(TRUE, TRUE, FALSE), values = 1, lbound = 0.001,
                        labels = c("p1", "p2", "p3"), name = "Props" )

# Specify the mixture model, with individual likelihood requested
mixExp <- mxExpectationMixture(components = c('Class1', 'Class2', 'Class3'), weights = 'Props', scale = 'sum')
fit <- mxFitFunctionML()

# Specify raw data
dataRaw <- mxData(mix.data, type="raw")

# Put them all together
gmm <- mxModel("Growth Mixture Model",
                        class1, class2, class3, classP, mixExp, fit, dataRaw)

# Run the model
gmmFit <- mxRun(gmm, suppressWarnings = TRUE)
```


Check the results (note that the results may depend heavily on the starting value; so it is recommended to run the model with multiple starting values.)

```{r}
summary(gmmFit)

```



<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>
